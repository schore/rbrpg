pipeline {
  agent any
  parameters {
    booleanParam(name: 'BUILD', defaultValue: false, description: 'Build jar file')
  }
  stages {
    stage('Prepare') {
      steps {
        sh 'npm install .'
        sh 'ls -la'
        sh 'lein deps'
      }
    }
   stage('test') {
      steps {
        sh 'npx --call=\'shadow-cljs compile app\''
        sh 'npx --call=\'lein test :all\''
      }
      post {
        always {
          junit 'target/test-reports/*.xml'
          sh 'rm -rf target/test-reports'
        }
      }
    }
    stage('build') {
      when {
        expression{ return params.BUILD }
      }
      steps {
        sh 'npx --call=\'lein uberjar\''
        archiveArtifacts artifacts: 'target/uberjar/lum.jar'
      }
    }
  }
}
